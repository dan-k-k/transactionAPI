# docker-compose.yml
services:
  # 1. The Database Service
  test-db:   # <--- Service Name
    image: postgres:15
    environment:
      POSTGRES_USER: user              # Must match conftest/connection string
      POSTGRES_PASSWORD: password
      POSTGRES_DB: test_transactions_db # Must match conftest/connection string
    ports:
      - "5433:5432" # Allows you to connect from Mac via localhost:5433
    healthcheck:
      # FIX: Updated to use the actual user/db defined above
      test: ["CMD-SHELL", "pg_isready -U user -d test_transactions_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. The Test Runner
  app_test:
    build: .
    environment:
      # FIX 1: Hostname must match the service name 'test-db'
      # FIX 2: Port must be 5432 (Internal Docker Network port, not the external 5433)
      # FIX 3: Creds must match what you set in test-db environment
      TEST_DATABASE_URL: postgresql://user:password@test-db:5432/test_transactions_db
    depends_on:
      test-db: # FIX: Must match service name defined on line 3
        condition: service_healthy
    command: pytest tests/ -v

